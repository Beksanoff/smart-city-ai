# API-запросы приложения Smart City AI

## Обзор

Фронтенд обращается к Go-бэкенду (`VITE_API_URL`, по умолчанию `http://localhost:8080`). Бэкенд в свою очередь дергает Open-Meteo, TomTom Traffic, ML-сервис (Python) и БД.

## Запросы при запуске приложения

| Момент | Запрос | Кто | Описание |
|--------|--------|-----|----------|
| Загрузка страницы | `GET /api/v1/dashboard` | Frontend (React Query) | **1 запрос**. Агрегированные погода + трафик. Вызывается в `useQuery(['dashboard'])` с `refetchInterval: 30000`. |
| При открытии вкладки «Аналитика» | `GET /api/v1/history/weather?hours=168` | Frontend | **1 запрос**. История погоды за 7 дней для графика AQI. |
| При открытии вкладки «Аналитика» | `GET /api/v1/history/traffic?hours=24` | Frontend | **1 запрос**. История трафика за 24 часа. |
| При открытии вкладки «Аналитика» | `GET /api/v1/stats` | Frontend | **1 запрос**. ML-статистика (месячные средние для графика «Температура vs Смог»). |

**Итого при холодном старте:** 1 запрос к бэкенду (`/api/v1/dashboard`).  
**При первом открытии «Аналитика»:** +3 запроса (weather history, traffic history, stats).

## Запросы при использовании

| Действие | Запрос | Частота |
|----------|--------|---------|
| Автообновление дашборда | `GET /api/v1/dashboard` | Каждые 30 с |
| Обновление истории (если вкладка «Аналитика» открыта) | `GET /api/v1/history/weather?hours=168`, `GET /api/v1/history/traffic?hours=24` | Каждые 5 мин |
| Обновление ML-статистики (вкладка «Аналитика») | `GET /api/v1/stats` | Каждые 10 мин |
| Отправка вопроса в «Планировщик» | `POST /api/v1/predict` | По кнопке «Получить прогноз» |
| Health check | `GET /health` | По необходимости (например, при проверке доступности бэкенда) |

## Внутренние вызовы бэкенда (Go)

- **GET /api/v1/dashboard** — внутри вызывает получение погоды и трафика (при наличии ключей — Open-Meteo и TomTom; иначе моки).
- **GET /api/v1/weather** — Open-Meteo или мок.
- **GET /api/v1/traffic** — TomTom Flow или симуляция.
- **GET /api/v1/history/weather**, **GET /api/v1/history/traffic** — из репозитория (БД или мок).
- **GET /api/v1/stats** — запрос к ML-сервису (`ML_SERVICE_URL/stats`).
- **POST /api/v1/predict** — запрос к ML-сервису (`ML_SERVICE_URL/predict`).

## Моки и захардкоженные данные

- **Фронтенд** (`frontend-react/src/services/api.ts`): при ошибке любого API-вызова подставляются мок-данные (`getMockDashboardData`, `getMockWeather`, `getMockTraffic`, `getMockPrediction`). У мок-ответов поле `is_mock: true`.
- **Бэкенд**: при пустом `DATABASE_URL` используется `MockRepository`; при отсутствии ключей погоды/трафика — мок-погода и симулированный трафик.
- **ML**: при отсутствии `GROQ_API_KEY` — мок-прогноз в `logic.py`.
- **Аналитика**: при отсутствии данных из БД/ML используются типичный почасовой паттерн трафика и средние по месяцам за 6 лет (fallback в графиках).

Подробнее см. отчёт исследования проекта (структура, API, моки, i18n).
